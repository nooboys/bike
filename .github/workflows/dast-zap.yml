
name: DAST - OWASP ZAP

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: "Target URL to scan (use localhost for container; or a legal test site)"
        required: false
        default: "http://localhost:8080"
      run_full_scan:
        description: "Run ACTIVE full scan (attacks target) - true/false"
        required: false
        default: "false"

  # Optional nightly full scan
  # schedule:
  #   - cron: "0 2 * * *"

jobs:
  baseline_scan:
    name: Baseline Scan (Passive)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pull app image
        run: docker pull ${{ secrets.DOCKERHUB_USERNAME }}/bike:featuret

      - name: Run app container
        run: |
          docker rm -f bikeapp || true
          docker run -d --name bikeapp -p 8080:8080 \
            ${{ secrets.DOCKERHUB_USERNAME }}/bike:featuret

      - name: Wait for app to be ready
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:8080/ > /dev/null; then
              echo "App is up!"
              exit 0
            fi
            echo "Waiting for app..."
            sleep 2
          done
          echo "App did not start in time"
          docker logs bikeapp
          exit 1

      # ZAP Baseline = passive scan (no attacks) [1](https://www.zaproxy.org/docs/docker/baseline-scan/)
      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.15.0
        with:
          target: ${{ github.event.inputs.target_url || 'http://localhost:8080' }}
          rules_file_name: ".zap/rules.tsv"
          # IMPORTANT: filenames here MUST match upload step below
          cmd_options: "-a -m 2 -r report_html.html -J report_json.json -w report_md.md"
          allow_issue_writing: false
          artifact_name: "zap-baseline"  # action can attach artifacts [2](https://github.com/zaproxy/action-baseline)

  full_scan:
    name: Full Scan (Active)
    runs-on: ubuntu-latest
    needs: baseline_scan

    # Run full scan only when explicitly requested (or scheduled)
    if: ${{ github.event_name == 'schedule' || github.event.inputs.run_full_scan == 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pull app image
        run: docker pull ${{ secrets.DOCKERHUB_USERNAME }}/bike:featuret

      - name: Run app container
        run: |
          docker rm -f bikeapp || true
          docker run -d --name bikeapp -p 8080:8080 \
            ${{ secrets.DOCKERHUB_USERNAME }}/bike:featuret

      - name: Wait for app to be ready
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:8080/ > /dev/null; then
              echo "App is up!"
              exit 0
            fi
            echo "Waiting for app..."
            sleep 2
          done
          echo "App did not start in time"
          docker logs bikeapp
          exit 1

      # ZAP Full Scan = active attacks [3](https://www.zaproxy.org/docs/docker/full-scan/)[4](https://github.com/zaproxy/action-full-scan)
      - name: ZAP Full Scan (ACTIVE)
        uses: zaproxy/action-full-scan@v0.13.0
        with:
          target: ${{ github.event.inputs.target_url || 'http://localhost:8080' }}
          rules_file_name: ".zap/rules.tsv"
          # -j uses Ajax spider; -m limits spider time; -a includes alpha rules [3](https://www.zaproxy.org/docs/docker/full-scan/)
          cmd_options: "-a -j -m 5 -r full_report.html -J full_report.json -w full_report.md"
          allow_issue_writing: false
          artifact_name: "zap-full"  # action can attach artifacts [4](https://github.com/zaproxy/action-full-scan)

      - name: Upload Full Scan Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-full-reports
          path: |
            full_report.html
            full_report.json
            full_report.md

