
name: DAST - OWASP ZAP

on:
  #push:
  #  branches: [ master ]
  workflow_dispatch:
  # Optional: run nightly full DAST checks
  # schedule:
  #   - cron: "0 2 * * *"

jobs:
  zap_baseline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Pull the Docker image you already publish OR build it here
      # Option 1: Pull from Docker Hub
      - name: Pull app image
        run: docker pull ${{ secrets.DOCKERHUB_USERNAME }}/bike:featuret

      - name: Run app container
        run: |
          docker run -d --name bikeapp -p 8080:8080 \
            ${{ secrets.DOCKERHUB_USERNAME }}/bike:featuret

      - name: Wait for app to be ready
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:8080/ > /dev/null; then
              echo "App is up!"
              exit 0
            fi
            echo "Waiting for app..."
            sleep 2
          done
          echo "App did not start in time"
          docker logs bikeapp
          exit 1

      # ---- OWASP ZAP Baseline Scan (Passive) ----
      # Baseline action scans a target URL and supports local URLs too. [2](https://github.com/zaproxy/action-baseline)
      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.15.0
        with:
          target: "http://localhost:8080"
          # Use stable ZAP container (default is stable; you can also specify docker_name)
          # docker_name: "ghcr.io/zaproxy/zaproxy:stable"
          rules_file_name: ".zap/rules.tsv"
          # Extra options passed to zap-baseline.py
          # -a includes alpha rules, -m sets spider minutes, -r/-J generate reports, etc. [1](https://www.zaproxy.org/docs/docker/baseline-scan/)
          cmd_options: "-a -m 2 -r zap_report.html -J zap_report.json -w zap_report.md"
          allow_issue_writing: false

      - name: Upload ZAP reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-baseline-reports
          path: |
            zap_report.html
            zap_report.json
            zap_report.md

